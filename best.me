/*
    best.me -- esp-best build targets
 */

Me.load({
    mixin: `
        function gzip(path: Path) {
            path.joinExt('gz', true).remove()
            run('gzip ' + path)
            path.write(run('gunzip -c ' + path + '.gz', {noshow: true}))
        }
        let app = me.package.app
        blend(app, app.modes[app.mode])
        app.http ||= {}
        app.http.content ||= {}
        let combine = app.http.content.combine
        let compress = app.http.content.compress
        let minify = app.http.content.minify
    `,

    targets: {
        'build-best': {
            home: '${TOP}',
            build: `
                trace('Compile', 'esp compile')
                run('esp -q compile')
            `,
        },

        'clean-best': {
            home: '${TOP}',
            type: 'clean',
            action: "rm('cache/*')",
        },

        'clean-best-minified': {
            home: '${TOP}',
            type: 'clean',
            action: `
                rm('**/*.min.*')
                rm('client/app/all.html.*')
            `
        },

        'all.min.css': {
            home: '${TOP}',
            enable: `combine.contains('css')`,
            path: 'client/css/all-${settings.version}.min.css',
            files: [ 'client/css/*.less' ],
            build: `
                let switches = minify.contains('css') ? '-compress' : ''
                let switches = ''
                trace('Parse', '*.less')
                if (minify.contains('css')) {
                    trace('Minify', TARGET.path.relative)
                    switches = '-compress'
                }
                rm(TARGET.path)
                strace('Run', 'recess ' + switches + ' -compile client/css/all.less')
                let result = Cmd.run('recess ' + switches + ' -compile client/css/all.less')
                if (result == '') {
                    throw 'Cannot build recess ' + switches + ' -compile client/css/all.less'
                }
                rm('client/css/all.css')
                for each (f in Path('client/css').files('*.css')) {
                    result += f.readString()
                }
                TARGET.path.write(result)
            `,
        },

        'all.min.css.gz': {
            home: '${TOP}',
            enable: `compress.contains('css')`,
            path: 'client/css/all-${settings.version}.min.css.gz',
            files: [ 'client/css/all-${settings.version}.min.css' ],
            depends: ['all.min.css']
            build: `
                trace('Compress', TARGET.path.relative)
                gzip('client/css/all-${settings.version}.min.css')
            `,
        },

        'min.html': {
            home: '${TOP}',
            enable: `minify.contains('html')`,
            path: 'client/app/all.html.js',
            files: [ '**.html' ],
            exclude: /client\/paks\/all.min.html/,
            build: `
                let list = []
                trace('Minify', '*.min.html')
                if (!Cmd.locate('htmlmin')) {
                    trace('Warning', 'Cannot locate "htmlmin" to minify.')
                }
                for each (f in Path('client').files('**.html', {exclude: /\\.min.html/})) {
                    let minified = f.replaceExt('min.html')
                    if (!minified.exists || minified.modified < f.modified) {
                        if (Cmd.locate('htmlmin')) {
                            run('htmlmin ' + f)
                        } else {
                            f.copy(minified)
                        }
                    }
                    if (compress.contains('html') && !combine.contains('html')) {
                        gzip(minified)
                    }
                }
            `,
        },

        'html.js': {
            home: '${TOP}',
            enable: `combine.contains('html')`,
            path: 'client/app/all.html.js',
            files: [ 'client/app/all.html.js' ],
            depends: ['min.html']
            build: `
                let list = Path('client').files('**.min.html')
                let all = Path('client/app/all.html.js')
                trace('Convert', all)
                all.append('angular.module("app").run(function(Esp, $templateCache) {')
                for each (let f:Path in list) {
                    let file = f.relativeTo('client').replace('.min.html', '.html')
                    let data = f.readLines()
                    for (let [key,value] in data) {
                        data[key] = value.replace(/"/g, '\\\\"')
                    }
                    data = data.join('\\\\\n')
                    all.append('\n    $templateCache.put(Esp.url("/' + file + '"), "' + data + '");\n')
                    f.remove()
                }
                all.append('});')
            `,
        },

        'html.js.gz': {
            home: '${TOP}',
            enable: `combine.contains('html') && compress.contains('html') && !combine.contains('js')`,
            path: 'client/app/all.html.js.gz',
            files: [ 'client/app/all.html.js' ],
            depends: ['html.js']
            build: `
                gzip('client/app/all.html.js')
            `,
        },

        'min.js': {
            home: '${TOP}',
            enable: `minify.contains('js')`,
            path: 'client/all-${settings.version}.min.js',
            files: [ '**.js' ],
            exclude: /client\/paks\/all.min.js|client\/paks\/spare\/|client\/paks\/html5shiv/,
            depends: ['html.js'],
            build: `
                trace('Minify', '*.js')
                if (!Cmd.locate('uglifyjs')) {
                    trace('Warning', 'Cannot locate "uglify" to minify. Will just catenate scripts.')
                }
                if (Cmd.locate('ngmin')) {
                    for each (f in Path('client/app').files('**.js', {exclude: /\\.min.js|\\.ng.js/})) {
                        let ng = f.replaceExt('ng.js')
                        if (!ng.exists || ng.modified < f.modified) {
                            run('ngmin ' + f + ' ' + ng)
                            run('uglifyjs -o ' + f.replaceExt('min.js') + ' ' + ng)
                            ng.remove()
                        }
                    }
                }
                let list = []
                for each (pattern in me.package.app.client.scripts) {
                    if (pattern.contains('less/less.js') && combine.contains('css')) continue
                    for each (script in Path('client').files(pattern, {exclude: /\\.min.js/})) {
                        list.push(script)
                    }
                }
                for each (f in list) {
                    let minified = f.replaceExt('min.js')
                    if (!minified.exists || minified.modified < f.modified) {
                        if (Cmd.locate('uglifyjs')) {
                            run('uglifyjs -o ' + f.replaceExt('min.js') + ' ' + f)
                        } else {
                            f.copy(f.replaceExt('min.js'))
                        }
                    }
                    if (compress.contains('js') && !combine.contains('js')) {
                        gzip(minified)
                    }
                }
            `,
        },

        'all.js': {
            home: '${TOP}',
            enable: `combine.contains('js')`,
            path: 'client/all-${settings.version}.min.js',
            files: [ '**.min.js' ],
            exclude: /client\/paks\/all.min.js|client\/paks\/spare\/|client\/paks\/html5shiv/,
            depends: ['min.js'],
            build: `
                trace('Catenate', TARGET.path.relative)
                rm('client/all.min.js')
                let list = []
                for each (pattern in me.package.app.client.scripts) {
                    if (pattern.contains('less/less.js') && combine.contains('css')) continue
                    for each (script in Path('client').files(pattern, {exclude: /\\.min.js/})) {
                        list.push(script.replaceExt('min.js'))
                    }
                }
                list += Path('client').files('app/**.min.js', {exclude: /main.min.js/})
                let all = TARGET.path
                for each (let f:Path in list) {
                    if (!f.exists) {
                        f = f.replace('.min.js', '.js')
                    }
                    strace('Append', f)
                    if (!minify.contains('js')) {
                        f = f.replace('.min.js', '.js')
                    }
                    all.append(';' + f.readString())
                }
            `,
        },

        'all.js.gz': {
            home: '${TOP}',
            enable: `compress.contains('js')`,
            path: 'client/all-${settings.version}.min.js.gz',
            files: [ 'client/all-${settings.version}.min.js' ],
            depends: ['all.js'],
            build: `
                trace('Compress', TARGET.path.relative)
                gzip(TARGET.path.trimExt('gz'))
            `,
        },
    },
})
